# Jellyfin Plugin: User Switcher & Quick Connect Helper (10.10.7)

Admin-only plugin that lets you:

- **Impersonate** any user in a **new tab** (no logout) using the official **Quick Connect** flow
- **Authorize** a **Quick Connect** code for the user of your choice (paste a 6-char code from the userâ€™s device)

All actions are logged. Built for **Jellyfin 10.10.7**.

---

## Install from Jellyfin Plugin Catalog

You can install via the built-in catalog by adding this repository:

1. In Jellyfin, go to: Dashboard â†’ Plugins â†’ Repositories
2. Click Add and use:
   - Name: JellySwitch
   - URL: https://<your-username>.github.io/JellySwitch/manifest.json
3. Open Plugins â†’ Catalog, search for "User Switcher", then Install.
4. Restart Jellyfin.

Notes:
- The URL above is served from GitHub Pages. Make sure GitHub Pages is enabled for this repo (Settings â†’ Pages â†’ Build from main, folder: /docs).
- Each release updates `docs/manifest.json` automatically via GitHub Actions.

## Manual install (zip)

- Download the latest `TechBrew.UserSwitcher-<version>.zip` from Releases
- Extract into your Jellyfin plugins directory under `TechBrew.UserSwitcher/`
- Restart Jellyfin

Typical plugin paths:
- Linux: /var/lib/jellyfin/plugins/
- Windows (service): %ProgramData%/Jellyfin/Server/plugins/
- Windows (user): %LocalAppData%/jellyfin/plugins/

## Development

Requirements:
- .NET SDK 8.0+
- Jellyfin server 10.10.x

Build:
```bash
# from repo root
 dotnet restore src/UserSwitcher.csproj
 dotnet publish src/UserSwitcher.csproj -c Release -o artifacts/publish
```

Local test install:
- Copy `artifacts/publish/` contents into your Jellyfin plugins directory under `TechBrew.UserSwitcher/`
- Restart Jellyfin

## Releasing

Create a tag and push (e.g., `v0.1.0`). The GitHub Actions workflow will:
- Build and publish the plugin
- Create a zip release asset: `TechBrew.UserSwitcher-<version>.zip`
- Compute SHA256 and update `docs/manifest.json` with:
  - `version`, `targetAbi`, `framework`
  - `sourceUrl` and `checksum`

Ensure GitHub Pages is enabled; the repository manifest will be available at:
`https://<your-username>.github.io/JellySwitch/manifest.json`

## Security & Permissions

- Endpoints are restricted to administrators; access is validated per request.
- Actions are logged with user, target user, and timestamp.

## Admin UI

- Dashboard â†’ Plugins â†’ User Switcher
- Features:
  - User search and selection
  - Impersonate: opens a new tab with a temporary session
  - Quick Connect: authorize a 6-character code for a specific user

---

## Original PRD

Got it ðŸš€ â€” hereâ€™s a **Product Requirements Document (PRD)** tailored for the **Jellyfin User Switcher / Quick Connect Helper plugin**. You can paste this straight into your editor to use as a build guide and hand back to me when youâ€™re ready for code.

---

# PRD: Jellyfin User Switcher & Quick Connect Helper

## Overview

A Jellyfin plugin that allows administrators to:

1. **Impersonate users**: Open a new browser tab already logged in as a selected user (ephemeral session).
2. **Authorize Quick Connect codes**: Paste a QC code generated by a device and bind it to any user of choice.

This plugin improves admin control, user onboarding, and troubleshooting by removing the need for manual password sharing or logouts.

---

## Goals

* Provide an **admin-only UI** within the Jellyfin dashboard.
* Enable admins to:

  * Search/select any Jellyfin user.
  * Generate a temporary impersonation session for troubleshooting.
  * Authorize an active Quick Connect code for a user of choice.
* Ensure all actions are logged for auditing.
* Compatible with **Jellyfin 10.10.7** and installable via the built-in **Plugin Catalog**.

---

## Non-Goals

* Persisting impersonation tokens (they must be short-lived).
* Generating Quick Connect codes directly (only devices generate them).
* Extending features to non-admin users.

---

## Functional Requirements

### 1. Admin Dashboard UI

* A new entry under **Dashboard â†’ Plugins â†’ User Switcher**.
* Components:

  * **User Search**: Search bar + dropdown of matching users.
  * **Impersonate Button**: Opens a new tab with the selected userâ€™s session.
  * **Quick Connect Authorization**:

    * Input field for a **6-character QC code**.
    * Dropdown to select target user.
    * Button: **Authorize Code**.

### 2. Server API Endpoints

Expose plugin-specific endpoints under `/Plugin/UserSwitcher`:

* `GET /Plugin/UserSwitcher/Users?search=<query>`
  Returns list of users (Id, Name, Policy).

* `POST /Plugin/UserSwitcher/Impersonate`
  Body: `{ userId: "<guid>" }`
  Flow: Initiate QC â†’ Authorize â†’ Authenticate â†’ return impersonation URL.
  Response: `{ impersonationUrl: "<url>" }`

* `POST /Plugin/UserSwitcher/AuthorizeCode`
  Body: `{ code: "<6-char>", userId: "<guid>" }`
  Flow: Forward to `/QuickConnect/Authorize`.
  Response: `{ ok: true }`

### 3. Logging & Security

* Only available to **Admin accounts**.
* Every impersonation or QC authorization action must be logged with:

  * Admin username
  * Target user
  * Timestamp
  * Action type (`Impersonation` or `AuthorizeCode`)
* Use Jellyfinâ€™s built-in `ILogger`.

---

## Technical Notes

* **Language/Framework**: C# (.NET, Jellyfin plugin SDK).
* **Target ABI**: `10.10.7` (stable).
* **Quick Connect APIs used**:

  * `POST /QuickConnect/Initiate`
  * `POST /QuickConnect/Authorize`
  * `POST /Users/AuthenticateWithQuickConnect`
* **Session handling**:

  * Impersonation session tokens expire per Jellyfin policy (no extension).
  * Optional: mark impersonation sessions with a banner (`?imp=1` in URL).

---

## Deliverables

1. **Plugin manifest.json** for catalog installation.
2. **Plugin.cs** implementing `IHasWebPages` for admin UI.
3. **Controller (UserSwitcherController.cs)** with required endpoints.
4. **Web UI** (`config.html` + `config.js`) with:

   * User search
   * Impersonate button
   * QC code input + authorize button
5. **README** with install/build instructions.

---

## Acceptance Criteria

* âœ… Plugin installs from catalog and appears under **Dashboard â†’ Plugins**.
* âœ… Admin can search for users.
* âœ… Clicking **Impersonate** opens Jellyfin in a new tab as that user.
* âœ… Entering a valid QC code + user â†’ device logs in as that user.
* âœ… All actions are logged.
* âœ… No non-admins can access the page or endpoints.
