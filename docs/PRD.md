# PRD: Jellyfin User Switcher & Quick Connect Helper

## Overview

A Jellyfin plugin that allows administrators to:

1. Impersonate users: Open a new browser tab already logged in as a selected user (ephemeral session).
2. Authorize Quick Connect codes: Paste a QC code generated by a device and bind it to any user of choice.

This plugin improves admin control, user onboarding, and troubleshooting by removing the need for manual password sharing or logouts.

---

## Goals

- Provide an admin-only UI within the Jellyfin dashboard.
- Enable admins to:
  - Search/select any Jellyfin user.
  - Generate a temporary impersonation session for troubleshooting.
  - Authorize an active Quick Connect code for a user of choice.
- Ensure all actions are logged for auditing.
- Compatible with Jellyfin 10.10.7 and installable via the built-in Plugin Catalog.

---

## Non-Goals

- Persisting impersonation tokens (they must be short-lived).
- Generating Quick Connect codes directly (only devices generate them).
- Extending features to non-admin users.

---

## Functional Requirements

### 1. Admin Dashboard UI

- A new entry under Dashboard → Plugins → User Switcher.
- Components:
  - User Search: Search bar + dropdown of matching users.
  - Impersonate Button: Opens a new tab with the selected user’s session.
  - Quick Connect Authorization:
    - Input field for a 6-character QC code.
    - Dropdown to select target user.
    - Button: Authorize Code.

### 2. Server API Endpoints

Expose plugin-specific endpoints under `/Plugin/UserSwitcher`:

- GET `/Plugin/UserSwitcher/Users?search=<query>`
  - Returns list of users (Id, Name, Policy).

- POST `/Plugin/UserSwitcher/Impersonate`
  - Body: `{ userId: "<guid>" }`
  - Flow: Initiate QC → Authorize → Authenticate → return impersonation URL.
  - Response: `{ impersonationUrl: "<url>" }`

- POST `/Plugin/UserSwitcher/AuthorizeCode`
  - Body: `{ code: "<6-char>", userId: "<guid>" }`
  - Flow: Forward to `/QuickConnect/Authorize`.
  - Response: `{ ok: true }`

### 3. Logging & Security

- Only available to Admin accounts.
- Every impersonation or QC authorization action must be logged with:
  - Admin username
  - Target user
  - Timestamp
  - Action type (Impersonation or AuthorizeCode)
- Use Jellyfin’s built-in ILogger.

---

## Technical Notes

- Language/Framework: C# (.NET, Jellyfin plugin SDK).
- Target ABI: 10.10.7 (stable).
- Quick Connect APIs used:
  - POST `/QuickConnect/Initiate`
  - POST `/QuickConnect/Authorize`
  - POST `/Users/AuthenticateWithQuickConnect`
- Session handling:
  - Impersonation session tokens expire per Jellyfin policy (no extension).
  - Optional: mark impersonation sessions with a banner (`?imp=1` in URL).

---

## Deliverables

1. Plugin manifest.json for catalog installation.
2. Plugin.cs implementing IHasWebPages for admin UI.
3. Controller (UserSwitcherController.cs) with required endpoints.
4. Web UI (config.html + config.js) with:
   - User search
   - Impersonate button
   - QC code input + authorize button
5. README with install/build instructions.

---

## Acceptance Criteria

- Plugin installs from catalog and appears under Dashboard → Plugins.
- Admin can search for users.
- Clicking Impersonate opens Jellyfin in a new tab as that user.
- Entering a valid QC code + user → device logs in as that user.
- All actions are logged.
- No non-admins can access the page or endpoints.
